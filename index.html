<!DOCTYPE html>

<!--
	Pixel sorting excercise
	Diego F. Goberna
	http://feiss.be
-->

<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Pixel sorting</title>
<style>
	body{
		font-family: sans-serif;
	}
</style>
</head>
<body>
	<p>Choose an image:</p>
	<p><input type="file" onchange="process(this)"></p>
	<p>Threshold: <input type="range" id="threshold" min="0" max="255" value="10" onchange="this.nextSibling.innerHTML= this.value; start()"><span>10</span></p>
	<canvas id="b"></canvas>

<script type="text/javascript">
	
var b= document.getElementById('b');
var c= b.getContext('2d');
var row;
var threshold=0;

function process(el){
	f= el.files[0];
	if (!f.type.match('image.*')) {
		return alert('Not an image');
	  }

	var reader = new FileReader();
	reader.onload = fileReadComplete;
	reader.readAsDataURL(f);
}

var img= new Image();
var fileReadComplete = function(e){
	img.src = e.target.result;
	(function(){
		if (img.complete){
			b.width= img.width;
			b.height= img.height;
			c.drawImage(img, 0, 0);
			start();
			}
		else {
			setTimeout(arguments.callee, 50);
			}
		})();
};

function start(){
	c.drawImage(img, 0, 0);
	threshold= parseInt(document.getElementById('threshold').value);
	row= 0;
	
	//if not in progress
	if (row==0) requestAnimationFrame(pixelSort);
}

function pixelSort(){

	var imdata= c.getImageData(0, row, b.width, 1);
	var data= imdata.data;

	var pixels= getPixelsArray(data);
	
	var start= 0;
	var end= findValueLess(pixels, row, threshold, start);
	while(start<b.width){
		var range= pixels.splice(start, end-start);
		range.sort(simpleMeanSort);
		pixels.splice.apply(pixels, [start,0].concat(range));
		
		start= end;
		end= findValueLess(pixels, row, threshold, start+1);
	}
		
	setDataFromPixelsArray(data, pixels);
	
	c.putImageData(imdata, 0, row);
	
	row++;
	if (row<b.height) requestAnimationFrame(pixelSort);
	else row= 0;
}

function getPixelsArray(data){
	var p= [], c;
	for (var i = 0; i < data.length/4; i++) {
		c= i*4;
		p.push({r: data[c+0], g: data[c+1], b: data[c+2]});
	};
	return p;
}

function simpleMeanSort(a,b){
	var aa= (a.r+a.g+a.b)/3;
	var bb= (b.r+b.g+b.b)/3;
	return aa<bb?-1: (aa>bb?1:0);
}

function setDataFromPixelsArray(data, pixels){
	var c;
	for (var i = 0; i < pixels.length; i++) {
		c= i*4;
		data[c+0]= pixels[i].r;
		data[c+1]= pixels[i].g;
		data[c+2]= pixels[i].b;
	}
}

function findValue(pixels, row, val, start){
	for (var i=start; i< pixels.length; i++){
		if (pixels[i].r==val.r && pixels[i].g==val.g && pixels[i].b==val.b) {
			return i;
		}
	}
	return pixels.length;
}

function findValueLess(pixels, row, val, start){
	for (var i=start; i< pixels.length; i++){
		if ((pixels[i].r+pixels[i].g+pixels[i].b)/3 < val) {
			return i;
		}
	}
	return pixels.length;
}


</script>

</body>
</html>